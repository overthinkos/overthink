version: '3'

tasks:
  container:
    desc: "Run a built image. Usage: task run:container -- <image>"
    cmds:
      - docker run --rm -it $(ov inspect --format tag {{.CLI_ARGS}})

  shell:
    desc: "Shell into a built image. Usage: task run:shell -- <image>"
    cmds:
      - ov shell {{.CLI_ARGS}}

  pod:install:
    desc: "Install quadlet service. Usage: task run:pod:install -- <image>"
    cmds:
      - ov pod install {{.CLI_ARGS}}

  pod:uninstall:
    desc: "Uninstall quadlet service. Usage: task run:pod:uninstall -- <image>"
    cmds:
      - ov pod uninstall {{.CLI_ARGS}}

  pod:start:
    desc: "Start quadlet service. Usage: task run:pod:start -- <image>"
    cmds:
      - ov pod start {{.CLI_ARGS}}

  pod:stop:
    desc: "Stop quadlet service. Usage: task run:pod:stop -- <image>"
    cmds:
      - ov pod stop {{.CLI_ARGS}}

  pod:status:
    desc: "Show quadlet service status. Usage: task run:pod:status -- <image>"
    cmds:
      - ov pod status {{.CLI_ARGS}}

  pod:logs:
    desc: "Show quadlet service logs. Usage: task run:pod:logs -- <image>"
    cmds:
      - ov pod logs {{.CLI_ARGS}}

  pod:update:
    desc: "Update quadlet image. Usage: task run:pod:update -- <image>"
    cmds:
      - ov pod update {{.CLI_ARGS}}

  vm:
    desc: "Run a QCOW2 image in QEMU. Usage: task run:vm -- <image> [tag]"
    preconditions:
      - sh: command -v qemu-system-x86_64 || command -v qemu-system-aarch64
        msg: "qemu not found -- install qemu-system"
      - sh: test -d output/qcow2
        msg: "No QCOW2 output found -- run 'task build:qcow2' first"
    vars:
      QEMU_RAM: '{{default "4G" .QEMU_RAM}}'
      QEMU_CPUS: '{{default "2" .QEMU_CPUS}}'
    cmds:
      - |
        set -- {{.CLI_ARGS}}
        IMAGE="$1"; TAG="${2:-latest}"
        DISK="output/qcow2/disk.qcow2"
        if [ ! -f "$DISK" ]; then
          echo "error: $DISK not found" >&2
          exit 1
        fi
        ARCH=$(uname -m)
        case "$ARCH" in
          x86_64)
            qemu-system-x86_64 \
              -m {{.QEMU_RAM}} -smp {{.QEMU_CPUS}} \
              -cpu host -enable-kvm \
              -drive file="$DISK",format=qcow2,if=virtio \
              -nic user,model=virtio-net-pci,hostfwd=tcp::2222-:22 \
              -serial mon:stdio -nographic
            ;;
          aarch64)
            qemu-system-aarch64 \
              -m {{.QEMU_RAM}} -smp {{.QEMU_CPUS}} \
              -cpu host -machine virt -enable-kvm \
              -drive file="$DISK",format=qcow2,if=virtio \
              -nic user,model=virtio-net-pci,hostfwd=tcp::2222-:22 \
              -serial mon:stdio -nographic
            ;;
          *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
        esac
